/*
 * Wazuh storeRemediationsModel
 * Copyright (C) 2015, Wazuh Inc.
 * May 03, 2024.
 *
 * This program is free software; you can redistribute it
 * and/or modify it under the terms of the GNU General Public
 * License (version 2) as published by the FSF - Free Software
 * Foundation.
 */

#include "updateHotfixes_test.hpp"
#include "flatbuffers/idl.h"
#include "flatbuffers/util.h"
#include <memory>

namespace NSUpdateHotfixesTest
{
    constexpr auto COMMON_DATABASE_DIR {"queue/vd"}; //<<Used for all databases
    const std::string FLATBUFFER_SCHEMA {FLATBUFFER_SCHEMAS_DIR "/cve5.fbs"};
    const char* FB_INCLUDE_DIRECTORIES[] = {FLATBUFFER_SCHEMAS_DIR, nullptr};

    const auto JSON_CVE5_VALID_ONE_BLOCK = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-1111-1111",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
                "x_remediations": {
                    "windows": [
                        {
                            "anyOf":["KBT-800","KBT-1000","KBT-3000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        }
                    ]
                }
            }
        }
    }
)";

    const auto JSON_CVE5_VALID_MULTIPLE_BLOCKS = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-2222-2222",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
                "x_remediations": {
                    "windows": [
                        {
                            "anyOf":["KBT-800","KBT-1000","KBT-3000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        },
                        {
                            "anyOf":["KBT-4000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        },
                        {
                            "anyOf":["KBT-5000","KBT-6000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        },
                        {
                            "anyOf":["KBT-7000","KBT-8000","KBT-9000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        }
                    ]
                }
            }
        }
    }
)";

    const auto JSON_CVE5_VALID_MULTIPLE_BLOCKS_SOME_WITH_NO_ANYOF = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-3333-3333",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
                "x_remediations": {
                    "windows": [
                        {
                            "anyOf":["KBT-800","KBT-1000","KBT-3000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        },
                        {
                            "anyOf":["KBT-4000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        },
                        {
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        },
                        {
                            "anyOf":["KBT-7000","KBT-8000","KBT-9000"],
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        }
                    ]
                }
            }
        }
    }
)";

    const auto JSON_CVE5_EMPTY_UPDATES = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-4444-4444",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
                "x_remediations": {
                    "windows": [
                        {
                            "products": ["Windows 10 - HastaLaVistaBaby", "Windows 11 - RiseOfTheMachines", "Windows 12 - Genisys"],
                            "type": "update"
                        }
                    ]
                }
            }
        }
    }
)";

    const auto JSON_CVE5_NO_REMEDIATIONS = R"(
    {
        "dataType": "CVE_RECORD",
        "dataVersion": "5.0",
        "cveMetadata": {
            "cveId": "CVE-5555-5555",
            "assignerOrgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6",
            "state": "PUBLISHED"
        },
        "containers": {
            "cna": {
                "providerMetadata": {
                    "orgId": "b3476cb9-2e3d-41a6-98d0-0f47421a65b6"
                },
                "problemTypes": [
                    {
                        "descriptions": [
                            {
                                "lang": "en",
                                "description": "CWE-78 OS Command Injection"
                            }
                        ]
                    }
                ],
                "affected": [
                    {
                        "vendor": "Example.org",
                        "product": "Example Enterprise",
                        "versions": [
                            {
                                "version": "1.0.0",
                                "status": "affected",
                                "lessThan": "1.0.6",
                                "versionType": "semver"
                            }
                        ],
                        "defaultStatus": "unaffected"
                    }
                ],
                "descriptions": [
                    {
                        "lang": "en",
                        "value": "OS Command Injection vulnerability parseFilename function of example.php in the Web Management Interface of Example.org Example Enterprise on Windows, MacOS and XT-4500 allows remote unauthenticated attackers to escalate privileges.\n\nThis issue affects:\n  *  1.0 versions before 1.0.6\n  *  2.1 versions from 2.16 until 2.1.9."
                    }
                ],
                "references": [
                    {
                        "url": "https://example.org/ESA-22-11-CVE-1337-1234"
                    }
                ],
            }
        }
    }
)";
}; // namespace NSUpdateHotfixesTest

using namespace NSUpdateHotfixesTest;

void UpdateHotfixesTest::SetUp()
{
    std::filesystem::remove_all(COMMON_DATABASE_DIR);
    std::filesystem::create_directories(COMMON_DATABASE_DIR);
};

void UpdateHotfixesTest::TearDown()
{
    std::filesystem::remove_all(COMMON_DATABASE_DIR);
};

TEST_F(UpdateHotfixesTest, UpdatesWindowsRemediationMultipleBlocks)
{
    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);

    // Parse schema.
    flatbuffers::Parser parser;
    parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES);
    parser.Parse(JSON_CVE5_VALID_MULTIPLE_BLOCKS);

    // Create a test Entry object with Windows remediations
    auto buffer = parser.builder_.GetBufferPointer();
    flatbuffers::Verifier verifier(buffer, parser.builder_.GetSize());
    cve_v5::VerifyEntryBuffer(verifier);
    auto entry = cve_v5::GetEntry(buffer);

    // Create a mock RocksDBWrapper object
    std::unique_ptr<Utils::IRocksDBWrapper> rocksDBWrapper = std::make_unique<Utils::RocksDBWrapper>(DATABASE_PATH);

    // Call the updateRemediation function with the test data
    EXPECT_NO_THROW(UpdateHotfixes::storeVulnerabilityHotfixes(entry, rocksDBWrapper.get()));

    // Validate the data was inserted
    std::vector<std::string> hotfixes {
        "KBT-800",
        "KBT-1000",
        "KBT-3000",
        "KBT-4000",
        "KBT-5000",
        "KBT-6000",
        "KBT-7000",
        "KBT-8000",
        "KBT-9000",
    };

    FlatbufferDataPair<NSVulnerabilityScanner::HotfixesApplications> fbHotfix;

    const std::string expectedCveId = "CVE-2222-2222";
    for (const auto& hotfix : hotfixes)
    {
        EXPECT_TRUE(rocksDBWrapper->get(hotfix, fbHotfix.slice, HOTFIXES_APPLICATIONS_COLUMN));
        fbHotfix.data = const_cast<NSVulnerabilityScanner::HotfixesApplications*>(
            NSVulnerabilityScanner::GetHotfixesApplications(fbHotfix.slice.data()));
        EXPECT_EQ(fbHotfix.data->CVEs()->size(), 1);
        EXPECT_EQ(fbHotfix.data->CVEs()->Get(0)->str(), expectedCveId);
    }
}

TEST_F(UpdateHotfixesTest, SkipsEmptyUpdates)
{
    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);

    // Parse schema.
    flatbuffers::Parser parser;
    parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES);
    parser.Parse(JSON_CVE5_EMPTY_UPDATES);

    // Create a test Entry object with Windows remediations
    auto buffer = parser.builder_.GetBufferPointer();
    flatbuffers::Verifier verifier(buffer, parser.builder_.GetSize());
    cve_v5::VerifyEntryBuffer(verifier);
    auto entry = cve_v5::GetEntry(buffer);

    // Create a mock RocksDBWrapper object
    std::unique_ptr<Utils::IRocksDBWrapper> rocksDBWrapper = std::make_unique<Utils::RocksDBWrapper>(DATABASE_PATH);

    // Call the updateRemediation function with the test data
    EXPECT_NO_THROW(UpdateHotfixes::storeVulnerabilityHotfixes(entry, rocksDBWrapper.get()));
}

TEST_F(UpdateHotfixesTest, MultipleVulnerabilities)
{
    // Create a mock RocksDBWrapper object
    std::unique_ptr<Utils::IRocksDBWrapper> rocksDBWrapper = std::make_unique<Utils::RocksDBWrapper>(DATABASE_PATH);

    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);

    // Parse schema.
    flatbuffers::Parser parser;

    {
        parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES);

        // Parse the first entry
        parser.Parse(JSON_CVE5_VALID_ONE_BLOCK);

        // Prepare the vulnerability
        auto buffer = parser.builder_.GetBufferPointer();
        flatbuffers::Verifier verifier(buffer, parser.builder_.GetSize());
        cve_v5::VerifyEntryBuffer(verifier);
        auto entry = cve_v5::GetEntry(buffer);

        // Insert the vulnerability
        EXPECT_NO_THROW(UpdateHotfixes::storeVulnerabilityHotfixes(entry, rocksDBWrapper.get()));
    }

    {
        // Parse schema.
        flatbuffers::Parser parser;
        parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES);

        // Parse the second entry
        parser.Parse(JSON_CVE5_VALID_MULTIPLE_BLOCKS);

        // Prepare the vulnerability
        auto buffer = parser.builder_.GetBufferPointer();
        flatbuffers::Verifier verifier(buffer, parser.builder_.GetSize());
        cve_v5::VerifyEntryBuffer(verifier);
        auto entry = cve_v5::GetEntry(buffer);

        // Insert the vulnerability
        EXPECT_NO_THROW(UpdateHotfixes::storeVulnerabilityHotfixes(entry, rocksDBWrapper.get()));
    }

    // Hotfix to CVE mapping
    std::map<std::string, std::vector<std::string>> hotfixesToCVEs {
        {"KBT-800", {"CVE-1111-1111", "CVE-2222-2222"}},
        {"KBT-3000", {"CVE-1111-1111", "CVE-2222-2222"}},
        {"KBT-4000", {"CVE-2222-2222"}},
        {"KBT-5000", {"CVE-2222-2222"}},
        {"KBT-6000", {"CVE-2222-2222"}},
        {"KBT-7000", {"CVE-2222-2222"}},
        {"KBT-8000", {"CVE-2222-2222"}},
        {"KBT-9000", {"CVE-2222-2222"}},
    };

    // Make sure the entries where inserted
    FlatbufferDataPair<HotfixesApplications> hotfixInfo;
    for (const auto& [hotfixIds, cveIds] : hotfixesToCVEs)
    {
        EXPECT_TRUE(rocksDBWrapper->get(hotfixIds, hotfixInfo.slice, HOTFIXES_APPLICATIONS_COLUMN));
        hotfixInfo.data = const_cast<HotfixesApplications*>(GetHotfixesApplications(hotfixInfo.slice.data()));
        EXPECT_EQ(hotfixInfo.data->CVEs()->size(), cveIds.size());
        for (const auto& cveId : cveIds)
        {
            // Check that the cve is in the list
            EXPECT_TRUE(std::find_if(hotfixInfo.data->CVEs()->begin(),
                                     hotfixInfo.data->CVEs()->end(),
                                     [&cveId](const flatbuffers::String* str)
                                     { return str->str() == cveId; }) != hotfixInfo.data->CVEs()->end());
        }
    }
}

TEST_F(UpdateHotfixesTest, StoreAndRemove)
{
    // Create a mock RocksDBWrapper object
    std::unique_ptr<Utils::IRocksDBWrapper> rocksDBWrapper = std::make_unique<Utils::RocksDBWrapper>(DATABASE_PATH);

    // Define schema variable and parse JSON object.
    std::string schemaStr;

    // Load file with schema.
    flatbuffers::LoadFile(FLATBUFFER_SCHEMA.c_str(), false, &schemaStr);

    // Parse schema.
    flatbuffers::Parser parser;

    // Store the following hotfixes:
    // KBT-800, KBT-1000, KBT-3000, KBT-4000, KBT-5000, KBT-6000, KBT-7000, KBT-8000, KBT-9000
    {
        // Parse schema.
        flatbuffers::Parser parser;
        parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES);

        // Parse the first entry
        parser.Parse(JSON_CVE5_VALID_MULTIPLE_BLOCKS);

        // Prepare the vulnerability
        auto buffer = parser.builder_.GetBufferPointer();
        flatbuffers::Verifier verifier(buffer, parser.builder_.GetSize());
        cve_v5::VerifyEntryBuffer(verifier);
        auto entry = cve_v5::GetEntry(buffer);

        // Insert the vulnerability
        EXPECT_NO_THROW(UpdateHotfixes::storeVulnerabilityHotfixes(entry, rocksDBWrapper.get()));
    }

    // Store the following hotfixes:
    // KBT-800, KBT-1000, KBT-3000
    {
        parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES);

        // Parse the first entry
        parser.Parse(JSON_CVE5_VALID_ONE_BLOCK);

        // Prepare the vulnerability
        auto buffer = parser.builder_.GetBufferPointer();
        flatbuffers::Verifier verifier(buffer, parser.builder_.GetSize());
        cve_v5::VerifyEntryBuffer(verifier);
        auto entry = cve_v5::GetEntry(buffer);

        // Insert the vulnerability
        EXPECT_NO_THROW(UpdateHotfixes::storeVulnerabilityHotfixes(entry, rocksDBWrapper.get()));
    }

    // Remove the following hotfixes:
    // KBT-4000, KBT-5000, KBT-6000, KBT-7000, KBT-8000, KBT-9000
    {
        parser.Parse(schemaStr.c_str(), FB_INCLUDE_DIRECTORIES);

        // Parse the first entry
        parser.Parse(JSON_CVE5_VALID_MULTIPLE_BLOCKS);

        // Prepare the vulnerability
        auto buffer = parser.builder_.GetBufferPointer();
        flatbuffers::Verifier verifier(buffer, parser.builder_.GetSize());
        cve_v5::VerifyEntryBuffer(verifier);
        auto entry = cve_v5::GetEntry(buffer);

        // Remove the hotfixes
        EXPECT_NO_THROW(UpdateHotfixes::removeHotfix(entry, rocksDBWrapper.get()));
    }

    // Remaining hotfixes:
    // KBT-800, KBT-1000, KBT-3000
    rocksdb::PinnableSlice slice;
    EXPECT_TRUE(rocksDBWrapper->get("KBT-800", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_TRUE(rocksDBWrapper->get("KBT-1000", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_TRUE(rocksDBWrapper->get("KBT-3000", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_FALSE(rocksDBWrapper->get("KBT-4000", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_FALSE(rocksDBWrapper->get("KBT-5000", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_FALSE(rocksDBWrapper->get("KBT-6000", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_FALSE(rocksDBWrapper->get("KBT-7000", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_FALSE(rocksDBWrapper->get("KBT-8000", slice, HOTFIXES_APPLICATIONS_COLUMN));
    EXPECT_FALSE(rocksDBWrapper->get("KBT-9000", slice, HOTFIXES_APPLICATIONS_COLUMN));
}
